/*!
 * Copyright 2016 Sergii Netesnyi.
 * Licensed under the Apache 2.0 license. Please see LICENSE for more information.
 *
 */
!function(){!function(){function t(){}function e(t,e,o){function r(t){_.extend(this,t)}var i={};return i.alias=o||t.toLowerCase(),i.table=t,i.hasOne=[],i.hasMany=[],r.prototype.entityClass=r,r.prototype.equals=function(t){for(var e=0;e<i.fields.length;e++){var n=i.fields[e].name;if(!_.isEqual(this[n],t[n]))return!1}return!0},r.prototype.clone=function(){return new r(_.clone(this))},r.get=function(t){return _.find(this.metadata.fields,{name:t})},r.hasOne=function(t,e,n,o){i.hasOne.push({entity:t,columnName:n,referencedColumnName:o||"id",propertyHolderName:e})},r.hasMany=function(t,e,n,o){i.hasMany.push({entity:t,columnName:n,referencedColumnName:o||"id",propertyHolderName:e})},_.isArray(e)?i.fields=_.map(e,function(t){return new n(r,t.name,t.type)}):i.fields=_.map(e,function(t,e){return new n(r,e,t)}),_.forEach(i.fields,function(t){r[t.name]=t}),r.metadata=i,r}function n(t,e,n){if(!n)throw new Error('No type defined for field "'+e+'" of entity "'+t.metadata.table+'"');this.entity=t,this.name=e,this.type=n}function o(t,e,n,o){if(!t)throw new Error('Check left operand to apply operator "'+n+'"');if(!e)throw new Error('Check right operand to apply operator "'+n+'"');this.leftOperand=l(t,e),this.rightOperand=l(e,t),this.operator=n,this.aggregator=o}function r(t,e){if(!t)throw new Error('Check operand to apply operator "'+e+'"');this.operand=l(t),this.operator=e}function i(t){this.value=t}function s(t){i.call(this,t)}function u(t,e){i.call(this,t),this.field=e}function a(t){i.call(this,t)}function l(t,e){if(_.isString(t)||_.isNumber(t)||_.isDate(t)||_.isBoolean(t))return new u(t,e instanceof n?e:void 0);if(t instanceof n)return new s(t);if(_.isArray(t))return new a(t);if(t instanceof o||t instanceof r)return t;throw new Error("Unmapped predicate "+t)}window.qjs&&window.qjs.logError("queryjs has been included twice");var c={Order:{ASC:"asc",DESC:"desc"}};window.qjs=c,c.debug=!1,c.SqlTypes={TEXT:{id:"TEXT",toSql:function(t){return t},fromSql:function(t){return t}},INT:{id:"INT",toSql:function(t){return t},fromSql:function(t){return t}},BOOL:{id:"BOOL",toSql:function(t){return _.isUndefined(t)||_.isNull(t)?null:t?1:0},fromSql:function(t){return _.isUndefined(t)||_.isNull(t)?null:!!t}},DATE:{id:"DATE",toSql:function(t){return _.isDate(t)?t.getTime():t},fromSql:function(t){return t?new Date(t):null}},JSON:{id:"DATE",toSql:function(t){return t?JSON.stringify(t):t},fromSql:function(t){return t?JSON.parse(t):t}}},c.logDebug=function(){c.debug&&window.console&&(window.console.debug?window.console.debug.apply(window.console,arguments):window.console.log.apply(window.console,arguments))},c.logError=function(){window.console&&(window.console.error?window.console.error.apply(window.console,arguments):window.console.log.apply(window.console,arguments))},c.from=function(t){return new c.Queries.SelectQuery(t)},c.insertInto=function(t){return new c.Queries.InsertQuery(t)},c.update=function(t){return new c.Queries.UpdateQuery(t)},c["delete"]=function(t){return new c.Queries.DeleteQuery(t)},c.define=function(t,n,o){return e(t,n,o)},c.defineAliased=function(t,e){return c.define(t.table,t.fields,e)},c.Transformers=c.Transformers||{},c.Queries=c.Queries||{},c.Predicates=c.Predicates||{},c.Predicates.BiPredicate=o,c.Predicates.UniPredicate=r,c.Transformers.ResultSetTransformer=t,t.prototype.transform=function(t,e){throw new Error('Method "transform" must be implemented in ResultSetTransformer')},n.prototype.getAlias=function(){return this.entity.metadata.alias+"_"+this.name},n.prototype.getFullPath=function(){return this.entity.metadata.alias+"."+this.name},n.prototype.eq=function(t){return new o(this,t,"=")},n.prototype.ne=function(t){return new o(this,t,"!=")},n.prototype.gt=function(t){return new o(this,t,">")},n.prototype.ge=function(t){return new o(this,t,">=")},n.prototype.lt=function(t){return new o(this,t,"<")},n.prototype.le=function(t){return new o(this,t,"<=")},n.prototype.isNotNull=function(){return new r(this,"is not NULL")},n.prototype.isNull=function(){return new r(this,"is NULL")},n.prototype["in"]=function(t){return new o(this,t,"in")},r.prototype.toSql=function(t){return this.operand.toSql(t)+" "+this.operator},o.prototype.toSql=function(t){var e=this.leftOperand.toSql(t)+" "+this.operator+" "+this.rightOperand.toSql(t);return this.aggregator?"("+e+")":e},o.prototype.or=function(t){return new o(this,t,"or",!0)},o.prototype.and=function(t){return new o(this,t,"and",!0)},i.prototype.toSql=function(t){throw new Error("To sql is not implemented for operand "+this)},s.prototype=_.create(i.prototype,{constructor:s}),s.prototype.toSql=function(){return this.value.entity.metadata.alias+"."+this.value.name},u.prototype=_.create(i.prototype,{constructor:u}),u.prototype.toSql=function(t){return t.push(this.field?this.field.type.toSql(this.value):this.value),"?"},a.prototype=_.create(i.prototype,{constructor:a}),a.prototype.toSql=function(t){if(!this.value.length)throw new Error("Empty array in the predicate");return _.forEach(this.value,function(e){t.push(_.isDate(e)?e.getTime():e)}),"(?"+_.repeat(",?",this.value.length-1)+")"}}(),function(){function t(t){this.entity=t,this.joins=[],this.orderBys=[],this.whereClauses=[],this.projectionValue=null,this.limitValue=null,this.offsetValue=null}function e(){this.fields=_.flatten(_.toArray(arguments))}function n(){e.call(this,arguments)}function o(){e.call(this,arguments)}function r(e,n,o){return this.root=e,t.call(this,o),this.type=n,this.joinEntity=o,this.onClauses=[],this}function i(t,e,n){return t[n.metadata.table]?e:(t[n.metadata.table]=!0,e=e.concat(n.metadata.fields),_.forEach(n.metadata.hasOne,function(n){e=i(t,e,n.entity)}),_.forEach(n.metadata.hasMany,function(n){e=i(t,e,n.entity)}),e)}function s(t){u.debugResultSet&&u.logDebug("ResultSet ("+t.length+" rows):\n"+_.map(t,function(t){return JSON.stringify(t)}).join("\n"))}window.qjs||console&&(console.error?console.error:console.log)("Add queryjs.core before using other modules");var u=window.qjs;u.debugResultSet=!1,u.Queries.SelectQuery=t,u.Projections=u.Projections||{},u.Projections.Projection=e,u.Projections.DistinctProjection=o,t.prototype.clone=function(){var e=new t(this.entity);return e.joins=_.map(this.joins,function(t){var n=new r(e,t.type,t.entity);return n.onClauses=_.clone(t.onClauses),n}),e.orderBys=_.cloneDeep(this.orderBys),e.whereClauses=_.map(this.whereClauses,function(t){return t}),e.projectionValue=this.projectionValue?this.projectionValue.clone():this.projectionValue,e.limitValue=this.limitValue,e.offsetValue=this.offsetValue,e},t.prototype.projection=function(t){return this.getRoot().projectionValue=t,this},t.prototype.distinct=function(t){return this.getRoot().projectionValue=new o(t),this},t.prototype.where=function(t){return this.getRoot().whereClauses.push(t),this},t.prototype.leftJoin=function(t){var e=new r(this.getRoot(),"LEFT",t);return this.getRoot().joins.push(e),e},t.prototype.join=function(t){var e=new r(this.getRoot(),"",t);return this.getRoot().joins.push(e),e},t.prototype.innerJoin=function(t){var e=new r(this.getRoot(),"INNER",t);return this.getRoot().joins.push(e),e},t.prototype.orderBy=function(t,e){return this.getRoot().orderBys.push({field:t,direction:e}),this},t.prototype.limit=function(t){return this.getRoot().limitValue=t,this},t.prototype.offset=function(t){return this.getRoot().offsetValue=t,this},t.prototype.getRoot=function(){return this},t.prototype.count=function(t){var e=new n;return this.projection(e),this.list(t,new u.Transformers.SingleValueSetTransformer(e.toSql()))},t.prototype.unique=function(t){return this.list(t,new u.Transformers.UniqueResultSetTransformer)},t.prototype.first=function(t){return this.list(t,new u.Transformers.FirstEntityResultSetTransformer)},t.prototype.list=function(t,o){var r=this,a=[];if(r.root)return r.root.list(t,o);var l=o||new u.Transformers.OneToManyListResultSetTransformer,c=this.projectionValue;if(!c){var f=_.chain([]).concat(this.entity).concat(_.map(this.joins,"joinEntity")).value(),p=i({},_.chain([]),this.entity).filter(function(t){return _.contains(f,t.entity)}).value();c=new e(p)}var h="SELECT "+c.toSql();return h+="\nFROM "+this.entity.metadata.table+" "+this.entity.metadata.alias,this.joins.length&&_.forEach(this.joins,function(t){h+="\n    "+t.type+" JOIN "+t.joinEntity.metadata.table+" "+t.joinEntity.metadata.alias+" on ",h+=_.map(t.onClauses,function(t){return t.toSql(a)}).join(" AND ")}),this.whereClauses.length&&(h+="\nWHERE ",h+=_.map(this.whereClauses,function(t){return t.toSql(a)}).join("\n AND ")),this.orderBys.length&&(h+="\nORDER BY ",h+=_.map(this.orderBys,function(t){return t.field.getFullPath()+" "+t.direction||u.Order.ASC}).join(", ")),c instanceof n||(this.limitValue?(h+="\nLIMIT "+this.limitValue,this.offsetValue&&(h+=" OFFSET "+this.offsetValue)):this.offsetValue&&u.logError("Setting OFFSET without LIMIT!")),new Promise(function(e,n){t?t.executeSql(h,a).then(function(t){s(t),e(l.transform(r.getRoot(),t))},n):u.transaction(function(t){t.executeSql(h,a).then(function(t){s(t),e(l.transform(r.getRoot(),t))},n)})})},e.prototype.toSql=function(){return this.fields.length?_.chain(this.fields).map(function(t){return t.getFullPath()+" as "+t.getAlias()}).join(", ").value():"*"},e.prototype.clone=function(){return new e(this.fields)},n.prototype=_.create(e.prototype,{constructor:n}),n.prototype.toSql=function(){return"count("+e.prototype.toSql.call(this)+")"},n.prototype.clone=function(){return new n(this.fields)},o.prototype=_.create(e.prototype,{constructor:o}),o.prototype.toSql=function(){return"distinct "+e.prototype.toSql.call(this)},o.prototype.clone=function(){return new o(this.fields)},r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.getRoot=function(){return this.root},r.prototype.on=function(t,e){if(t instanceof u.Predicates.BiPredicate||t instanceof u.Predicates.UniPredicate)this.onClauses.push(t);else{if(_.isUndefined(t))throw new Error("Left operand of join clause is undefined. Joining table "+this.joinEntity.metadata.table+". The join column might be misspelled or not defined");if(_.isUndefined(e))throw new Error("Right operand of join clause is undefined. Joining table "+this.joinEntity.metadata.table+". The join column might be misspelled or not defined");this.onClauses.push(new u.Predicates.BiPredicate(t,e,"="))}return this},r.prototype.clone=function(){var t=new r(this.root.clone(),this.type,this.entity);return t.onClauses=_.clone(this.onClauses),t}}(),function(){function t(t){this.entity=t,this.whereClauses=[],this.setClauses=[],this.entityValue=null}function e(t,e){this.field=t,this.value=e}window.qjs||console&&(console.error?console.error:console.log)("Add queryjs.core before using other modules");var n=window.qjs;n.Queries.UpdateQuery=t,t.prototype.set=function(t,n){return this.setClauses.push(new e(t,n)),this},t.prototype.values=function(t){return this.entityValue=t,this},t.prototype.where=function(t){return this.whereClauses.push(t),this},t.prototype.execute=function(t){var e=this,o=[],r="UPDATE "+this.entity.metadata.table;return this.entityValue&&_.forEach(this.entityValue.entityClass.metadata.fields,function(t){var n=e.entityValue[t.name];_.isUndefined(n)||e.set(t,n)}),this.setClauses.length&&(r+="\nSET ",r+=_.map(this.setClauses,function(t){return t.toSql(o)}).join(", ")),this.whereClauses.length&&(r+="\nWHERE ",r+=_.map(this.whereClauses,function(t){return t.toSql(o)}).join("\n AND ")),new Promise(function(e,i){t?t.executeSql(r,o).then(e,i):n.transaction(function(t){t.executeSql(r,o).then(e,i)})})},e.prototype.toSql=function(t){return t.push(this.field.type.toSql(this.value)),this.field.name+" = ?"}}(),function(){function t(t){this.entity=t,this.setClauses=[],this.entityValue=null}function e(t,e){this.field=t,this.value=e}window.qjs||console&&(console.error?console.error:console.log)("Add queryjs.core before using other modules");var n=window.qjs;n.Queries.InsertQuery=t,t.prototype.set=function(t,n){return this.setClauses.push(new e(t,n)),this},t.prototype.values=function(t){return this.entityValue=t,this},t.prototype.execute=function(t){var e=this,o=[],r="INSERT INTO "+this.entity.metadata.table,i=this.entityValue.entityClass||this.entity;return this.entityValue&&_.forEach(i.metadata.fields,function(t){var n=e.entityValue[t.name];_.isUndefined(n)||e.set(t,n)}),this.setClauses.length&&(r+="\n(",r+=_.map(this.setClauses,function(t){return t.collectArgs(o),t.field.name}).join(", "),r+=") \nVALUES(?"+_.repeat(",?",this.setClauses.length-1)+")"),new Promise(function(e,i){t?t.executeSql(r,o).then(e,i):n.transaction(function(t){t.executeSql(r,o).then(e,i)})})},e.prototype.collectArgs=function(t){t.push(this.field.type.toSql(this.value))}}(),function(){function t(t){this.entity=t,this.whereClauses=[]}window.qjs||console&&(console.error?console.error:console.log)("Add queryjs.core before using other modules");var e=window.qjs;e.Queries.DeleteQuery=t,t.prototype.where=function(t){return this.whereClauses.push(t),this},t.prototype.execute=function(t){var n=[],o="DELETE FROM "+this.entity.metadata.table;return this.whereClauses.length&&(o+="\nWHERE ",o+=_.map(this.whereClauses,function(t){return t.toSql(n)}).join("\n AND ")),new Promise(function(r,i){t?t.executeSql(o,n).then(r,i):e.transaction(function(t){t.executeSql(o,n).then(r,i)})})}}(),function(){function t(){}function e(){}function n(){}function o(t){this.columnName=t}function r(t,e){var n=_.cloneDeep(t),o={};return _.forEach(e.metadata.fields,function(t){var e=n[t.getAlias()];o[t.name]=t.type.fromSql(e),delete n[t.getAlias()]}),_.forEach(e.metadata.hasOne,function(t){var e=r(n,t.entity);o[t.propertyHolderName]=e}),new e(o)}function i(){}function s(t,e){var n=_.groupBy(e,t.id.getAlias());return _.chain(n).map(function(e){var n={};_.forEach(t.metadata.hasMany,function(t){var o=s(t.entity,e);n[t.propertyHolderName]=o});var o=e[0];_.forEach(t.metadata.fields,function(t){var e=o[t.getAlias()];_.isUndefined(e)||(n[t.name]=t.type.fromSql(e))}),_.forEach(t.metadata.hasOne,function(t){n[t.propertyHolderName]=r(o,t.entity)});var i=!0;return _.forEach(n,function(t){i&&(i=_.isUndefined(t)||_.isNull(t)||t.entityClass||_.isArray(t)&&!t.length)}),i?null:new t(n)}).compact().value()}window.qjs||console&&(console.error?console.error:console.log)("Add queryjs.core before using other modules");var u=window.qjs;u.Transformers.SimpleListResultSetTransformer=t,u.Transformers.OneToManyListResultSetTransformer=i,u.Transformers.UniqueResultSetTransformer=e,u.Transformers.FirstEntityResultSetTransformer=n,u.Transformers.SingleValueSetTransformer=o,t.prototype=_.create(u.Transformers.ResultSetTransformer.prototype,{constructor:t}),t.prototype.transform=function(t,e){return _.map(e,function(e){return r(e,t.entity)})},e.prototype=_.create(u.Transformers.ResultSetTransformer.prototype,{constructor:e}),e.prototype.transform=function(t,e){var n=s(t.entity,e);if(1!==n.length)throw new Error("Expected single result, but found: "+e.length);return n[0]},n.prototype=_.create(u.Transformers.ResultSetTransformer.prototype,{constructor:n}),n.prototype.transform=function(t,e){var n=s(t.entity,e);return n.length?n[0]:null},o.prototype=_.create(u.Transformers.ResultSetTransformer.prototype,{constructor:o}),o.prototype.transform=function(t,e){return e.length?e[0][this.columnName]:null},i.prototype=_.create(u.Transformers.ResultSetTransformer.prototype,{constructor:i}),i.prototype.transform=function(t,e){var n=s(t.entity,e);return n}}(),function(){window.qjs||console&&(console.error?console.error:console.log)("Add queryjs.core before using other modules");var t=window.qjs;t.store=t.store||{},t.store.cordovasql={},t.store.cordovasql.config=function(e,n,o,r,i,s){var u=null;if(t.transaction=function(t){if(!u)throw new Error("No ongoing database connection, please connect first.");u.transaction(t)},t.db=t.db||{},t.db.implementation="unsupported",t.db.conn=null,window&&"sqlitePlugin"in window?t.db.implementation="sqliteplugin":window&&window.openDatabase&&(t.db.implementation="websql"),t.db.sqliteplugin={},t.db.sqliteplugin.connect=function(e,n,o){var r={},i=window.sqlitePlugin.openDatabase({name:e,bgType:n,location:o||0});return r.transaction=function(e){return i.transaction(function(n){return e(t.db.sqliteplugin.transaction(n))})},r},t.db.sqliteplugin.transaction=function(e){var n={};return n.executeSql=function(n,o){return new Promise(function(r,i){var s=(new Date).getTime();e.executeSql(n,o,function(e,i){t.logDebug(n,o,"\n{executed in",(new Date).getTime()-s,"ms}");for(var u=[],a=0;a<i.rows.length;a++)u.push(i.rows.item(a));r(u)},function(e,r){t.logError("Error executing sql query. \nQuery:\n",n,"\nArgs:\n",o,"\nError:\n",r),i(r.message)})})},n},t.db.websql={},t.db.websql.connect=function(e,n,o,r){var i={},s=openDatabase(e,n,o,r);return i.transaction=function(e){return s.transaction(function(n){return e(t.db.websql.transaction(n))})},i},t.db.websql.transaction=function(e){var n={};return n.executeSql=function(n,o,r,i){return new Promise(function(r,i){var s=(new Date).getTime();e.executeSql(n,o,function(e,i){t.logDebug(n,o,"\n{executed in",(new Date).getTime()-s,"ms}");for(var u=[],a=0;a<i.rows.length;a++)u.push(i.rows.item(a));r(u)},function(e,r){t.logError("Error executing sql query. \nQuery:\n",n,"\nArgs:\n",o,"\nError:\n",r),i(r.message)})})},n},t.db.connect=function(e,n,o,r,i,s){return"sqliteplugin"===t.db.implementation?t.db.sqliteplugin.connect(e,i,s):"websql"===t.db.implementation?t.db.websql.connect(e,n,o,r):null},u=t.db.connect(e,n,o,r,i,s),!u)throw new Error("No supported database found in this browser.")}}()}();